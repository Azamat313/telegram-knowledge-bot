"""
Нормализатор текста: транслитерация казахской латиницы в кириллицу,
приведение к нижнему регистру, удаление спецсимволов, коррекция опечаток.
"""

import re
import unicodedata

# Казахская латиница → кириллица (новый казахский алфавит на основе латиницы)
# Диграфы (обрабатываются первыми, до одиночных символов)
_DIGRAPH_MAP = {
    "sh": "ш",
    "ch": "ч",
    "zh": "ж",
    "ng": "ң",
}

# Одиночные символы с диакритикой и без
_LATIN_TO_CYRILLIC = {
    "a": "а",
    "á": "ә",  # a с акутом → ә
    "ä": "ә",  # альтернативная запись
    "b": "б",
    "d": "д",
    "e": "е",
    "f": "ф",
    "g": "г",
    "ǵ": "ғ",  # g с акутом → ғ
    "ğ": "ғ",  # альтернативная запись
    "h": "х",
    "i": "и",
    "í": "і",  # i с акутом → і
    "j": "ж",
    "k": "к",
    "l": "л",
    "m": "м",
    "n": "н",
    "ń": "ң",  # n с акутом → ң
    "ñ": "ң",  # альтернативная запись
    "o": "о",
    "ó": "ө",  # o с акутом → ө
    "ö": "ө",  # альтернативная запись
    "p": "п",
    "q": "қ",
    "r": "р",
    "s": "с",
    "t": "т",
    "u": "у",
    "ú": "ұ",  # u с акутом → ұ
    "ū": "ұ",  # альтернативная запись
    "v": "в",
    "w": "у",
    "x": "кс",
    "y": "й",
    "ý": "ү",  # y с акутом → ү
    "ÿ": "ү",  # альтернативная запись
    "z": "з",
}

# Частые опечатки (русский + казахский)
_TYPO_CORRECTIONS = {
    "щас": "сейчас",
    "чо": "что",
    "шо": "что",
    "скоко": "сколько",
    "скока": "сколько",
    "ваще": "вообще",
    "нада": "надо",
    "помагите": "помогите",
    "памагите": "помогите",
    "паступление": "поступление",
    "паступленне": "поступление",
    "дакументы": "документы",
    "докуметы": "документы",
    "докумнты": "документы",
    "стипендя": "стипендия",
    "стипенди": "стипендия",
    "расписане": "расписание",
    "росписание": "расписание",
    "общежите": "общежитие",
    "общага": "общежитие",
    "зачотка": "зачётка",
    "экзамен": "экзамен",
    "екзамен": "экзамен",
    "сесия": "сессия",
    "сэссия": "сессия",
    "библеотека": "библиотека",
    "библотека": "библиотека",
    "деканад": "деканат",
    "диканат": "деканат",
}


def _is_latin(text: str) -> bool:
    """Проверяет, содержит ли текст латинские символы."""
    return bool(re.search(r"[a-zA-Z\u00C0-\u024F]", text))


def _is_cyrillic(text: str) -> bool:
    """Проверяет, содержит ли текст кириллические символы."""
    return bool(re.search(r"[а-яА-ЯёЁәғқңөұүіӘҒҚҢӨҰҮІ]", text))


def transliterate_kaz_latin_to_cyrillic(text: str) -> str:
    """
    Транслитерирует казахский текст с латиницы на кириллицу.
    Обрабатывает диграфы, символы с диакритикой, смешанные тексты.
    """
    if not _is_latin(text):
        return text

    result = text.lower()

    # Нормализуем Unicode (NFC → NFD для разделения диакритики, потом обратно)
    result = unicodedata.normalize("NFC", result)

    # Сначала заменяем диграфы (они длиннее и приоритетнее)
    for digraph, cyrillic in _DIGRAPH_MAP.items():
        result = result.replace(digraph, cyrillic)

    # Затем одиночные символы
    new_result = []
    for char in result:
        if char in _LATIN_TO_CYRILLIC:
            new_result.append(_LATIN_TO_CYRILLIC[char])
        else:
            new_result.append(char)

    return "".join(new_result)


def normalize_text(text: str) -> str:
    """
    Полная нормализация текста:
    1. Приведение к нижнему регистру
    2. Транслитерация казахской латиницы → кириллица
    3. Удаление лишних пробелов и спецсимволов
    4. Коррекция частых опечаток
    """
    if not text:
        return ""

    # 1. Нижний регистр
    text = text.lower().strip()

    # 2. Транслитерация латиницы → кириллица (если есть латинские символы)
    if _is_latin(text):
        # Если текст смешанный или полностью латинский — транслитерируем
        text = transliterate_kaz_latin_to_cyrillic(text)

    # 3. Удаление спецсимволов (оставляем буквы, цифры, пробелы, дефис)
    text = re.sub(r"[^\w\s\-]", " ", text, flags=re.UNICODE)

    # 4. Удаление лишних пробелов
    text = re.sub(r"\s+", " ", text).strip()

    # 5. Коррекция опечаток (по словам)
    words = text.split()
    corrected_words = []
    for word in words:
        corrected_words.append(_TYPO_CORRECTIONS.get(word, word))
    text = " ".join(corrected_words)

    return text
